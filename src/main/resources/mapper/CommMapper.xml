<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mtf.edumarine.mapper.CommMapper">

    <select id="getTemplateContent" parameterType="java.lang.String" resultType="com.mtf.edumarine.dto.TemplateDTO">
        /* com.mtf.edumarine.mapper.CommMapper.getTemplateContent */
        SELECT seq
             , title
             , content
             , del_yn
             , note
             , init_regi_pic
             , init_regi_dttm
             , final_regi_pic
             , final_regi_dttm
        FROM template
        WHERE note = #{target}
        AND del_yn = 'N'
        LIMIT 1
    </select>

    <select id="getSmsSendingJoinList" parameterType="com.mtf.edumarine.dto.SmsNotificationDTO" resultType="java.lang.String">
        /* com.mtf.edumarine.mapper.CommMapper.getSmsSendingJoinList */
        SELECT phone
        FROM member
        WHERE sms_yn = '1'
          AND del_yn = 'N'
          AND apply_status != '탈퇴'
          AND seq = #{seq}
    </select>

    <select id="getSmsSendingKeywordList" parameterType="com.mtf.edumarine.dto.SmsNotificationDTO" resultType="java.lang.String">
        /* com.mtf.edumarine.mapper.CommMapper.getSmsSendingKeywordList */
        SELECT phone
        FROM member
        WHERE sms_yn = '1'
          AND del_yn = 'N'
          AND apply_status != '탈퇴'
          AND keyword LIKE CONCAT('%', #{keyword}, '%')
    </select>

    <select id="getSmsSendingTrainNotiList" resultType="com.mtf.edumarine.dto.TrainDTO">
        /* com.mtf.edumarine.mapper.CommMapper.getSmsSendingTrainNotiList */
        SELECT r.train_seq as seq
             , r.member_seq as memberSeq
             , m.phone
             , t.gbn
             , t.train_start_dttm
             , t.train_end_dttm
             , t.next_time
        FROM (SELECT r.train_seq
                   , r.member_seq
              FROM regular r
              WHERE r.apply_status NOT LIKE CONCAT('%', '취소', '%')
              UNION ALL
              SELECT b.train_seq
                   , b.member_seq
              FROM boarder b
              WHERE b.apply_status NOT LIKE CONCAT('%', '취소', '%')
              UNION ALL
              SELECT f.train_seq
                   , f.member_seq
              FROM frp f
              WHERE f.apply_status NOT LIKE CONCAT('%', '취소', '%')
              UNION ALL
              SELECT i.train_seq
                   , i.member_seq
              FROM inboarder i
              WHERE i.apply_status NOT LIKE CONCAT('%', '취소', '%')
              UNION ALL
              SELECT o.train_seq
                   , o.member_seq
              FROM outboarder o
              WHERE o.apply_status NOT LIKE CONCAT('%', '취소', '%')
              UNION ALL
              SELECT s.train_seq
                   , s.member_seq
              FROM sailyacht s
              WHERE s.apply_status NOT LIKE CONCAT('%', '취소', '%')
              ) r
        JOIN member m
        ON r.member_seq = m.seq
        JOIN train t
        ON r.train_seq = t.seq
        WHERE m.sms_yn = '1'
          AND m.del_yn = 'N'
          AND m.apply_status != '탈퇴'
          AND t.closing_yn = 'N'
          AND t.del_yn = 'N'
          AND TIMESTAMPDIFF(DAY, DATE_FORMAT(NOW(), '%Y.%m.%d'), DATE_FORMAT(t.train_start_dttm, '%Y.%m.%d')) = 2
    </select>

    <select id="selectMemberGradeUpdateTarget" resultType="com.mtf.edumarine.dto.MemberGradeDTO">
        /* com.mtf.edumarine.mapper.CommMapper.selectMemberGradeUpdateTarget */
        SELECT rs.seq
             , rs.apply_status
             , rs.name
             , rs.sms_yn
             , rs.grade
             , (CASE
                    WHEN sms_yn = 1 OR regularCnt = 1
                        THEN CASE
                                 WHEN outboarderCnt = 1 OR inboarderCnt = 1 OR sailyachtCnt = 1 THEN '교육생(단기)'
                                 WHEN boarderCnt = 1 OR frpCnt = 1 THEN '교육생(정규)'
                                 ELSE '관심사용자'
                        END
                    ELSE '일반회원'
            END) AS afterGrade
        FROM (SELECT m.seq
                   , m.apply_status
                   , m.name
                   , m.sms_yn
                   , m.grade
                   , (SELECT COUNT(*)
                      FROM regular r
                      WHERE r.member_seq = m.seq AND r.apply_status NOT LIKE CONCAT('%', '취소', '%')) AS regularCnt
                   , (SELECT COUNT(*)
                      FROM boarder b
                      WHERE b.member_seq = m.seq AND b.apply_status NOT LIKE CONCAT('%', '취소', '%')) AS boarderCnt
                   , (SELECT COUNT(*)
                      FROM frp f
                      WHERE f.member_seq = m.seq AND f.apply_status NOT LIKE CONCAT('%', '취소', '%')) AS frpCnt
                   , (SELECT COUNT(*)
                      FROM outboarder o
                      WHERE o.member_seq = m.seq AND o.apply_status NOT LIKE CONCAT('%', '취소', '%')) AS outboarderCnt
                   , (SELECT COUNT(*)
                      FROM inboarder i
                      WHERE i.member_seq = m.seq AND i.apply_status NOT LIKE CONCAT('%', '취소', '%')) AS inboarderCnt
                   , (SELECT COUNT(*)
                      FROM sailyacht s
                      WHERE s.member_seq = m.seq AND s.apply_status NOT LIKE CONCAT('%', '취소', '%')) AS sailyachtCnt
              FROM member m
              WHERE m.apply_status != '탈퇴'
                AND m.del_yn = 'N') rs
    </select>

    <update id="updateMemberGrade" parameterType="com.mtf.edumarine.dto.MemberGradeDTO">
        /* com.mtf.edumarine.mapper.CommMapper.updateMemberGrade */
        UPDATE member
        SET grade = #{afterGrade}
          , final_regi_dttm = DATE_FORMAT(NOW(), '%Y-%m-%d %T')
        WHERE seq = #{seq}
    </update>

</mapper>

