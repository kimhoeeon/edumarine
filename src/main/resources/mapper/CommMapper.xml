<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.mtf.edumarine.mapper.CommMapper">

    <select id="getTemplateContent" parameterType="java.lang.String" resultType="com.mtf.edumarine.dto.TemplateDTO">
        /* com.mtf.edumarine.mapper.CommMapper.getTemplateContent */
        SELECT seq
             , title
             , content
             , del_yn
             , note
             , init_regi_pic
             , init_regi_dttm
             , final_regi_pic
             , final_regi_dttm
        FROM template
        WHERE note = #{target}
        AND del_yn = 'N'
        LIMIT 1
    </select>

    <select id="getSmsSendingJoinList" parameterType="com.mtf.edumarine.dto.SmsNotificationDTO" resultType="java.lang.String">
        /* com.mtf.edumarine.mapper.CommMapper.getSmsSendingJoinList */
        SELECT phone
        FROM member
        WHERE sms_yn = '1'
          AND del_yn = 'N'
          AND apply_status != '탈퇴'
          AND seq = #{seq}
    </select>

    <select id="getSmsSendingKeywordList" parameterType="com.mtf.edumarine.dto.SmsNotificationDTO" resultType="java.lang.String">
        /* com.mtf.edumarine.mapper.CommMapper.getSmsSendingKeywordList */
        SELECT phone
        FROM member
        WHERE sms_yn = '1'
          AND del_yn = 'N'
          AND apply_status != '탈퇴'
          AND keyword LIKE CONCAT('%', #{keyword}, '%')
    </select>

    <select id="getSmsSendingTrainNotiList" resultType="com.mtf.edumarine.dto.TrainDTO">
        /* com.mtf.edumarine.mapper.CommMapper.getSmsSendingTrainNotiList */
        SELECT r.train_seq as seq
             , r.member_seq as memberSeq
             , m.phone
             , t.gbn
             , t.train_start_dttm
             , t.train_end_dttm
             , t.next_time
        FROM (SELECT r.train_seq
                   , r.member_seq
              FROM regular r
              WHERE r.apply_status NOT LIKE CONCAT('%', '취소', '%')
              UNION ALL
              SELECT b.train_seq
                   , b.member_seq
              FROM boarder b
              WHERE b.apply_status NOT LIKE CONCAT('%', '취소', '%')
              UNION ALL
              SELECT f.train_seq
                   , f.member_seq
              FROM frp f
              WHERE f.apply_status NOT LIKE CONCAT('%', '취소', '%')
              UNION ALL
              SELECT i.train_seq
                   , i.member_seq
              FROM inboarder i
              WHERE i.apply_status NOT LIKE CONCAT('%', '취소', '%')
              UNION ALL
              SELECT o.train_seq
                   , o.member_seq
              FROM outboarder o
              WHERE o.apply_status NOT LIKE CONCAT('%', '취소', '%')
              UNION ALL
              SELECT s.train_seq
                   , s.member_seq
              FROM sailyacht s
              WHERE s.apply_status NOT LIKE CONCAT('%', '취소', '%')
              ) r
        JOIN member m
        ON r.member_seq = m.seq
        JOIN train t
        ON r.train_seq = t.seq
        WHERE m.sms_yn = '1'
          AND m.del_yn = 'N'
          AND m.apply_status != '탈퇴'
          AND t.closing_yn = 'N'
          AND t.del_yn = 'N'
          AND TIMESTAMPDIFF(DAY, DATE_FORMAT(NOW(), '%Y.%m.%d'), DATE_FORMAT(t.train_start_dttm, '%Y.%m.%d')) = 2
    </select>

</mapper>

